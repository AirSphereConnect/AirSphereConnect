# Build stage
FROM node:20-alpine AS builder

WORKDIR /app

# Copier package.json et package-lock.json
COPY package*.json ./

# Installer les dépendances avec legacy-peer-deps pour Unovis (pas encore compatible Angular 20)
RUN npm ci --legacy-peer-deps

# Copier le code source
COPY . .

# Build de l'application Angular en mode développement
# Note: Ce Dockerfile est pour le DÉVELOPPEMENT uniquement
# Pour la prod, utilisez Dockerfile (sans .dev)
RUN npm run build -- --configuration development

# Production stage
FROM nginx:alpine

# Installer curl pour health check (pas besoin de gettext en dev)
RUN apk add --no-cache curl

# Copier les fichiers buildés depuis le dossier browser (Angular moderne)
COPY --from=builder /app/dist/air-sphere-connect-front/browser /usr/share/nginx/html

# Configuration Nginx pour Angular
COPY nginx.conf /etc/nginx/conf.d/default.conf

# Exposer le port 4200 pour cohérence avec docker-compose
EXPOSE 4200

# Démarrer Nginx sur le port 4200
CMD ["nginx", "-g", "daemon off;"]
